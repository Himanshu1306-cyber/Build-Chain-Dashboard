<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildChain Dasboard | Firebase Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root { --sidebar-width: 250px; --primary-color: #00dc82; --bg-dark: #02070d; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: #efeef2; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: #0f172a; padding: 24px; z-index: 1000; border-right: 1px solid #1e293b; }
        .main-content { margin-left: var(--sidebar-width); padding: 50px; }
        .project-item { padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: 0.2s; margin-bottom: 15px; color: #90a3b7; }
        .project-item.active { background: var(--primary-color); color: #02070d; font-weight: 700; }
        .project-item:hover:not(.active) { background: #1e293b; color: white; }
        .glass-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; color: #0f172a; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: #0f172a; }
        .hash-code { font-family: monospace; font-size: 0.8rem; color: #6366f1; background: #f1f5f9; padding: 3px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="sidebar d-flex flex-column">
    <h3 class="fw-bold mb-4 text-white">üèóÔ∏è BuildChain</h3>
    <p class="small text-uppercase fw-bold text-muted mb-3">Cloud Projects</p>
    <button id="authBtn" class="btn btn-warning w-100 mb-3" onclick="handleAuth()">Login with Google</button>
    <div id="projectList" class="flex-grow-1"></div>
    <button class="btn btn-outline-light w-100" onclick="addNewProjectPrompt()">+ New Project</button>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold mb-1" id="displayProjName">Loading Cloud...</h1>
            <span class="badge bg-primary">Project ID: <span id="displayProjId">-</span></span>
        </div>
        <button id="connectBtn" class="btn btn-light fw-bold px-4" onclick="connectWallet()">Connect Wallet</button>
    </div>

    <div class="row mb-4">
        <div class="col-md-6"><div class="glass-card text-center"><p class="text-muted mb-1">Materials Logged</p><div id="logCount" class="stat-value">0</div></div></div>
        <div class="col-md-6"><div class="glass-card text-center"><p class="text-muted mb-1">Blockchain Status</p><div class="stat-value text-success">Secure</div></div></div>
    </div>

    <div class="glass-card">
        <h5 class="fw-bold mb-4">üì¶ New Delivery Entry</h5>
        <div class="row g-3">
            <div class="col-md-4"><input type="text" id="matName" class="form-control" placeholder="Material Name"></div>
            <div class="col-md-2"><input type="number" id="matQty" class="form-control" placeholder="Qty"></div>
            <div class="col-md-4"><input type="text" id="matPhoto" class="form-control" placeholder="IPFS Hash"></div>
            <div class="col-md-2"><button class="btn btn-dark w-100" onclick="addNewEntry()">Send Data</button></div>
        </div>
    </div>

    <div class="glass-card">
        <h6 class="fw-bold mb-4 text-muted">Immutable Transaction Ledger</h6>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead><tr><th>Material</th><th>Qty</th><th>Time</th><th>Current Hash</th></tr></thead>
                <tbody id="logTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    // --- FIREBASE CONFIG (Aapke Screenshot se) ---
    const firebaseConfig = {
        apiKey: "AIzaSyD9XCbZFItbtq-luerMm7IDeXHAtba3nW8",
        authDomain: "buildchain-e1bab.firebaseapp.com",
        projectId: "buildchain-e1bab",
        storageBucket: "buildchain-e1bab.firebasestorage.app",
        messagingSenderId: "31404283138",
        appId: "1:31404283138:web:6db9c71e6ed63ea2059e1b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // --- AUTH LOGIC START ---
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

async function handleAuth() {
    if (!auth.currentUser) {
        await auth.signInWithPopup(provider);
    } else {
        await auth.signOut();
        location.reload(); 
    }
}


// --- AUTH LOGIC END ---

    const contractAddress = "0xA937BF6609Cba6bBb430E8Dbd63818A854f41BBb"; 
    const abi = [
        "function getProjectLogs(uint _projectId) public view returns (tuple(string name, uint quantity, string photoHash, uint timestamp)[])",
        "function addMaterial(uint _projectId, string memory _name, uint _quantity, string memory _photoHash) public"
    ];

    let contract;
    let projects = [];
    let currentActiveId = 1;

   // Isse Line 126 par paste karein (window.onload ki jagah)
auth.onAuthStateChanged(user => {
    const btn = document.getElementById("authBtn");
    const dashboard = document.querySelector(".main-content");
    const projectList = document.getElementById("projectList");

    if (user) {
        // Jab user Login ho jaye
        btn.innerText = "Logout (" + user.displayName.split(' ')[0] + ")";
        dashboard.style.opacity = "1";
        dashboard.style.pointerEvents = "auto";
        loadProjectsFromFirebase(); 
    } else {
        // Jab user Logout ho
        btn.innerText = "Login with Google";
        dashboard.style.opacity = "0.1";
        dashboard.style.pointerEvents = "none";
        projectList.innerHTML = ""; // Sidebar clear kar do
    }
});

  async function loadProjectsFromFirebase() {
    const snapshot = await db.collection("projects").orderBy("id", "asc").get();
    projects = [];
    snapshot.forEach(doc => { projects.push(doc.data()); });

    if (projects.length > 0) {
        // Pehla project auto-select karein
        switchProject(projects[0].id, projects[0].name);
        renderSidebar(); 
    } else {
        // Agar database khali hai toh default project banayein
        await db.collection("projects").add({ id: 1, name: "Project Alpha" });
        location.reload();
    }
} // Line 143 par ye bracket confirm karein

    function renderSidebar() {
        const list = document.getElementById("projectList");
        list.innerHTML = "";
        projects.forEach(p => {
            const active = p.id == currentActiveId ? 'active' : '';
            list.innerHTML += `<div class="project-item ${active}" onclick="switchProject(${p.id}, '${p.name}')"># ${p.name}</div>`;
        });
    }


    async function addNewProjectPrompt() {
        const name = prompt("Enter Project Name:");
        if (name) {
            const newId = projects.length + 1;
            const newProj = { id: newId, name: name };
            await db.collection("projects").add(newProj);
            loadProjectsFromFirebase();
        }
    }

   function switchProject(id, name) {
    currentActiveId = id;
    // Dhyan dein: ID 'displayProjName' honi chahiye (HTML Line 39 ke mutabiq)
    document.getElementById("displayProjName").innerText = name; 
    document.getElementById("displayProjId").innerText = id;    

    renderSidebar(); 
    if(contract) loadBlockchainData();
}
    async function connectWallet() {
        if (window.ethereum) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            contract = new ethers.Contract(contractAddress, abi, provider.getSigner());
            document.getElementById("connectBtn").innerText = "Connected ";
            loadBlockchainData();
        }
    }

    async function loadBlockchainData() {
        try {
            const logs = await contract.getProjectLogs(currentActiveId);
            const table = document.getElementById("logTable");
            table.innerHTML = "";
            logs.forEach(log => {
                const date = new Date(log.timestamp.toNumber() * 1000).toLocaleString();
                table.innerHTML += `<tr>
                    <td class="fw-bold">${log.name}</td>
                    <td><span class="badge bg-primary">${log.quantity}</span></td>
                    <td class="text-muted small">${date}</td>
                    <td><span class="hash-code">0x...${Math.random().toString(16).slice(2,8)}</span></td>
                </tr>`;
            });
            document.getElementById("logCount").innerText = logs.length;
        } catch (e) { console.error(e); }
    }

    async function addNewEntry() {
        if (!contract) return alert("Connect Wallet!");
        const name = document.getElementById('matName').value;
        const qty = document.getElementById('matQty').value;
        try {
            const tx = await contract.addMaterial(currentActiveId, name, qty, "NA");
            await tx.wait();
            loadBlockchainData();
        } catch (e) { alert(e.message); }
    }
</script>
</body>
</html>